<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>vuex路由刷新数据重置和F5刷新数据保持 - crisman</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/"><span>Github</span></a></li><li><a href="https://www.v2ex.com/"><span>V2EX</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="http://callfiles.ueibo.com/hexo-theme-laughing/post_background.jpg"><div class="post-title"><h1 class="title">vuex路由刷新数据重置和F5刷新数据保持</h1><ul class="meta"><li><i class="icon icon-author"></i>crisman</li><li><i class="icon icon-clock"></i>21 Minutes</li><li><i class="icon icon-calendar"></i>2018年10月18日</li></ul></div></div><div class="article-content" style="max-width:800px"><p>项目中遇到的问题，记录一下。</p>
<p><img src="https://blog-10039692.file.myqcloud.com/1504751009021_60_1504751009399.jpeg" alt="pic"></p>
<a id="more"></a>
<h3 id="一、vuex路由刷新数据更新"><a href="#一、vuex路由刷新数据更新" class="headerlink" title="一、vuex路由刷新数据更新"></a><strong>一、vuex路由刷新数据更新</strong></h3><p>vuex 的设计是将数据存在一个对象树的变量中，我们的应用（vue应用）从这个变量中取数据，然后供应用使用，当将当前页面关闭， vuex 中的变量会随着消失，重新打开页面的时候，需要重新生成。<br>而，浏览器缓存（cookie，localstorage等）是将数据存到浏览器的某个地方，关闭页面，不会自动清空这些数据，当再次打开这个页面时，还是能取到之前存在浏览器上的数据（cookie，localstorage等）。<br>要使用 vuex 还是使用浏览器缓存，要看具体的业务场景。比如：像用户校验的 token 就可以存在 cookie 中，因为用户再次登录的时候能用到。而像用户的权限数据，这些是有一定安全性考虑，且不同用户的权限不同，放在 vuex 中更合理，用户退出时，自动销毁。</p>
<h4 id="1）组件刷新"><a href="#1）组件刷新" class="headerlink" title="1）组件刷新"></a><strong>1）组件刷新</strong></h4><p>provider、reject的组件刷新方式<br>作用：允许一个祖先组件向其所有子孙后代注入一个依赖，不论组件层次有多深，并在起上下游关系成立的时间里始终生效。</p>
<h4 id="App-vue"><a href="#App-vue" class="headerlink" title="App.vue:"></a><strong>App.vue:</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;qb-app&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;qb-content&quot;&gt;</span><br><span class="line">            &lt;qb-header&gt;&lt;/qb-header&gt;</span><br><span class="line">            &lt;router-view v-if=&quot;isRouterAlive&quot;&gt;&lt;/router-view&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;qb-footer&gt;&lt;/qb-footer&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import QbHeader from &apos;@/components/QbHeader&apos;</span><br><span class="line">import QbFooter from &apos;@/components/QbFooter&apos;</span><br><span class="line">import store from &apos;@/store/index&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">    name: &apos;App&apos;,</span><br><span class="line">    provide()&#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            reload:this.reload</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    data()&#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            isRouterAlive:true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods:&#123;</span><br><span class="line">        reload()&#123;</span><br><span class="line">            this.isRouterAlive = false</span><br><span class="line">            this.$nextTick(function()&#123;</span><br><span class="line">            this.isRouterAlive = true</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">        resetStates() &#123;</span><br><span class="line">            store.dispatch(&apos;changeResetState&apos;, &#123;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    // beforeRouteLeave(to,from,next)&#123;</span><br><span class="line"></span><br><span class="line">    // &#125;,</span><br><span class="line">    watch : &#123;</span><br><span class="line">        $route(to,from) &#123;</span><br><span class="line">           this.resetStates(); </span><br><span class="line">           console.log(&apos;watch正在监控路由变化&apos;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    components: &#123;</span><br><span class="line">        QbHeader,</span><br><span class="line">        QbFooter</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h4 id="createpage-index-vue"><a href="#createpage-index-vue" class="headerlink" title="createpage/index.vue"></a><strong>createpage/index.vue</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;create-page&quot;&gt;</span><br><span class="line">        &lt;el-row :gutter=&quot;20&quot;&gt;</span><br><span class="line">            &lt;el-col :span=&quot;8&quot; class=&quot;style-aside-left&quot; style=&quot;padding-left: 20px;padding-right: 20px;&quot;&gt;</span><br><span class="line">                &lt;style-select class=&quot;style-select&quot; &gt;&lt;/style-select&gt;</span><br><span class="line">                &lt;style-setting &gt;&lt;/style-setting&gt;</span><br><span class="line">            &lt;/el-col&gt;</span><br><span class="line">            &lt;el-col :span=&quot;16&quot; class=&quot;style-aside-right&quot; style=&quot;padding-left: 0px;padding-right: 0px;&quot;&gt;</span><br><span class="line">                &lt;style-preview &gt;&lt;/style-preview&gt;</span><br><span class="line">            &lt;/el-col&gt;</span><br><span class="line">        &lt;/el-row&gt; </span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    import StyleSelect from &apos;@/page/createPage/StyleSelect&apos;</span><br><span class="line">    import StyleSetting from &apos;@/page/createPage/StyleSetting&apos;</span><br><span class="line">    import StylePreview from &apos;@/page/createPage/StylePreview&apos;</span><br><span class="line">    import store from &apos;@/store/index&apos;</span><br><span class="line">    import axios from &apos;axios&apos;</span><br><span class="line"></span><br><span class="line">    export default &#123;</span><br><span class="line">        inject: [&apos;reload&apos;],</span><br><span class="line">        data()&#123;</span><br><span class="line">            return &#123;</span><br><span class="line">                // isReload:false</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        components: &#123;</span><br><span class="line">            StylePreview,</span><br><span class="line">            StyleSetting,</span><br><span class="line">            StyleSelect</span><br><span class="line">        &#125;,</span><br><span class="line">        mounted () &#123;</span><br><span class="line">            if(this.$route.query.id !== undefined)&#123;</span><br><span class="line">                axios.get(&apos;/api/itemData&apos;, &#123;</span><br><span class="line">                    params: &#123;</span><br><span class="line">                        id: this.$route.query.id</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).then(response =&gt; &#123;</span><br><span class="line">                    // console.log(&apos;itemresponse&apos;,response)</span><br><span class="line">                        store.dispatch(&apos;changeStyleId&apos;, &#123;</span><br><span class="line">                            styleId: response.data.data[0].TempName</span><br><span class="line">                        &#125;)</span><br><span class="line">                        store.dispatch(&apos;changeValueFromDatabase&apos;, &#123;</span><br><span class="line">                            styleId: response.data.data[0].TempName,</span><br><span class="line">                            formData:response.data.data[0].formData</span><br><span class="line">                        &#125;)</span><br><span class="line">                        // console.log(&apos;response.data.data[0].formData&apos;,response.data.data[0].formData)</span><br><span class="line">                        // this.formDataBase = response.data.data[0].formData</span><br><span class="line">                    &#125;).catch(function (error) &#123;</span><br><span class="line">                        console.log(error);</span><br><span class="line">                        console.log(&apos;id___error&apos;)</span><br><span class="line">                    &#125;);</span><br><span class="line">            &#125;else if (this.$route.query.index == &apos;new&apos; )&#123;</span><br><span class="line">                this.$route.query.index = &apos;done&apos;</span><br><span class="line">                this.reload();</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h4 id="2）vuex路由跳转数据重置"><a href="#2）vuex路由跳转数据重置" class="headerlink" title="2）vuex路由跳转数据重置"></a><strong>2）vuex路由跳转数据重置</strong></h4><p>专门用一个新的resetState，来处理需要被重置的内容</p>
<h4 id="store-state-js"><a href="#store-state-js" class="headerlink" title="store/state.js"></a><strong>store/state.js</strong></h4><p><em>//截取部分代码</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import formConfig from &apos;../common/formConfig&apos;</span><br><span class="line">import initState from &apos;./resetState&apos;</span><br><span class="line">export default &#123;</span><br><span class="line">	initState()&#123;</span><br><span class="line">		return initState</span><br><span class="line">	&#125;,</span><br><span class="line">	styleId: &apos;floatlayer&apos;</span><br></pre></td></tr></table></figure></p>
<h4 id="store-mutation-js"><a href="#store-mutation-js" class="headerlink" title="store/mutation.js"></a><strong>store/mutation.js</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//重新路由 数据重置mutation</span><br><span class="line">changeResetState(state,data)&#123;</span><br><span class="line">  	if (state.initState &amp;&amp; typeof state.initState === &apos;function&apos;) &#123;</span><br><span class="line">	    // const initState = state.initState();</span><br><span class="line">	    const initState = state.initState()</span><br><span class="line">	    console.log(&apos;state&apos;,state)</span><br><span class="line">	    for (const key in initState) &#123;</span><br><span class="line">      		state[key] = initState[key];</span><br><span class="line">	    &#125;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>会出现一个问题</strong>：只在第一次路由跳转时数据重置<br><strong>原因</strong>：两个state数据其实是引用数据类型，会指向同一块堆内存，因此需要在数据重置时，在mutation里面进行深拷贝:</p>
<h4 id="store-mutation-js-1"><a href="#store-mutation-js-1" class="headerlink" title="store/mutation.js"></a><strong>store/mutation.js</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//重新路由 数据重置mutation</span><br><span class="line">changeResetState(state,data)&#123;</span><br><span class="line">  	if (state.initState &amp;&amp; typeof state.initState === &apos;function&apos;) &#123;</span><br><span class="line">	    // const initState = state.initState();</span><br><span class="line">	    const initState = JSON.parse(JSON.stringify(state.initState()))</span><br><span class="line">	    console.log(&apos;state&apos;,state)</span><br><span class="line">	    for (const key in initState) &#123;</span><br><span class="line">      		state[key] = initState[key];</span><br><span class="line">	    &#125;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二、vuex-F5刷新页面-数据保持"><a href="#二、vuex-F5刷新页面-数据保持" class="headerlink" title="二、vuex F5刷新页面 数据保持"></a><strong>二、vuex F5刷新页面 数据保持</strong></h3><p>事实上并没有什么有效的方法让vuex在刷新的时候数据保持，现在试过唯一可行的办法就是利用浏览器的localstotrage，在数据更新store时保存一份到localstorage中，代码如下：</p>
<h4 id="store-mutation-js-2"><a href="#store-mutation-js-2" class="headerlink" title="store/mutation.js"></a><strong>store/mutation.js</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">changeValue (state, data) &#123;</span><br><span class="line">	const item = state.styleSettingDataMap[data.styleId].find(item =&gt; item.key === data.key)</span><br><span class="line">	// localStorage.setItem(data.key, data.value); </span><br><span class="line">	item.value = data.value</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="store-state-js-1"><a href="#store-state-js-1" class="headerlink" title="store/state.js"></a><strong>store/state.js</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">			name: &apos;主标题&apos;,</span><br><span class="line">			key: &apos;title&apos;,</span><br><span class="line">			type: &apos;text&apos;,</span><br><span class="line">			value: localStorage.getItem(&quot;title&quot;) || &apos;您使用的浏览器存在安全隐患&apos;</span><br><span class="line">		&#125;,&#123;</span><br><span class="line">			name: &apos;副标题&apos;,</span><br><span class="line">			key: &apos;desc&apos;,</span><br><span class="line">			type: &apos;text&apos;,</span><br><span class="line">			value: localStorage.getItem(&quot;desc&quot;) || &apos;微软已停止更新和安全维护，建议升级快速安全稳定的 QQ浏览器&apos;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>完结  项目中遇到的两个小问题，是以自己的项目为例，记录以为自用。</p>
</div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/vuex/">vuex</a><span class="tag-list-count">2</span></li></ul></div><div class="categories"><i class="icon icon-category"></i><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/front-end/">front-end</a><span class="category-list-count">9</span></li></ul></div></div><div class="article-comment" style="max-width:800px"><div class="ds-thread" id="ds-thread" data-thread-key="cjoi7vooh000vc2p4sqwni2kf" data-title="vuex路由刷新数据重置和F5刷新数据保持" data-url="http://yoursite.com/2018/10/18/vuex-router-one/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  //ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
  || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2018/11/12/xiaoaojianghu/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2018/01/02/html5-meta/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/icrisman" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://weibo.com/p/1005051957963162/home" title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li><li><a href="https://www.douban.com/people/72740604/statuses" title="Douban" target="_blank"><i class="icon icon-douban"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2018 crisman<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>